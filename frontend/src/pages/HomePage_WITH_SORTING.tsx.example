// Example HomePage component with sort functionality

import React, { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import { resolveImageUrl, formatPrice } from '../utils/imageHelper'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type SortOption = 'date_desc' | 'date_asc' | 'price_asc' | 'price_desc'

interface Listing {
  _id: string
  title: string
  description: string
  price: number
  city: string
  category: string
  tags: string[]
  images: string[]
  posted_date: string
}

export const HomePage: React.FC = () => {
  const [latestListings, setLatestListings] = useState<Listing[]>([])
  const [categories, setCategories] = useState<string[]>([])
  const [selectedCategory, setSelectedCategory] = useState<string>('')
  const [sortBy, setSortBy] = useState<SortOption>('date_desc')
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadData()
  }, [selectedCategory, sortBy])

  const loadData = async () => {
    setLoading(true)
    try {
      // Load latest listings with sorting
      const listingsUrl = selectedCategory 
        ? `${API_URL}/listings?category=${selectedCategory}&limit=12&sort_by=${sortBy}`
        : `${API_URL}/listings/latest?limit=12&sort_by=${sortBy}`
      
      const listingsRes = await fetch(listingsUrl)
      const listingsData = await listingsRes.json()
      setLatestListings(Array.isArray(listingsData) ? listingsData : [])

      // Load categories (only once)
      if (categories.length === 0) {
        const categoriesRes = await fetch(`${API_URL}/listings/categories`)
        const categoriesData = await categoriesRes.json()
        setCategories(Array.isArray(categoriesData) ? categoriesData : [])
      }
    } catch (error) {
      console.error('Failed to load data:', error)
    } finally {
      setLoading(false)
    }
  }

  const getSortLabel = (option: SortOption): string => {
    const labels: Record<SortOption, string> = {
      date_desc: 'Newest First',
      date_asc: 'Oldest First',
      price_asc: 'Price: Low to High',
      price_desc: 'Price: High to Low'
    }
    return labels[option]
  }

  return (
    <div className="page">
      <div className="hero">
        <h1>Find What You Need</h1>
        <p className="hero-subtitle">Browse the latest listings in your area</p>
      </div>

      <div className="categories-section">
        <h3>Browse by Category</h3>
        <div className="categories-grid">
          <button
            className={`category-chip ${!selectedCategory ? 'active' : ''}`}
            onClick={() => setSelectedCategory('')}
          >
            All
          </button>
          {categories.map((cat) => (
            <button
              key={cat}
              className={`category-chip ${selectedCategory === cat ? 'active' : ''}`}
              onClick={() => setSelectedCategory(cat)}
            >
              {cat.replace('_', ' ')}
            </button>
          ))}
        </div>
      </div>

      {/* Sort Controls */}
      <div className="sort-section" style={{ 
        display: 'flex', 
        alignItems: 'center', 
        gap: '1rem', 
        marginBottom: '1.5rem',
        padding: '1rem',
        backgroundColor: '#f5f5f5',
        borderRadius: '8px'
      }}>
        <label htmlFor="sort-select" style={{ fontWeight: 'bold' }}>
          Sort by:
        </label>
        <select
          id="sort-select"
          value={sortBy}
          onChange={(e) => setSortBy(e.target.value as SortOption)}
          style={{
            padding: '0.5rem 1rem',
            fontSize: '1rem',
            borderRadius: '4px',
            border: '1px solid #ddd',
            cursor: 'pointer',
            backgroundColor: 'white'
          }}
        >
          <option value="date_desc">Newest First</option>
          <option value="date_asc">Oldest First</option>
          <option value="price_asc">Price: Low to High</option>
          <option value="price_desc">Price: High to Low</option>
        </select>
      </div>

      <div className="listings-section">
        <h3>{selectedCategory ? `${selectedCategory.replace('_', ' ')} Listings` : 'Latest Listings'}</h3>
        {loading ? (
          <div className="loading">Loading...</div>
        ) : latestListings.length === 0 ? (
          <div className="empty-state">No listings found</div>
        ) : (
          <div className="listings-grid">
            {latestListings.map((listing) => (
              <Link
                key={listing._id}
                to={`/listing/${listing._id}`}
                className="listing-card"
              >
                {listing.images && listing.images.length > 0 ? (
                  <img
                    src={resolveImageUrl(listing.images[0])}
                    alt={listing.title}
                    className="listing-image"
                  />
                ) : (
                  <div className="listing-image-placeholder">No Image</div>
                )}
                <div className="listing-content">
                  <div className="listing-header">
                    <h4 className="listing-title">{listing.title}</h4>
                    <span className="listing-price">{formatPrice(listing.price)}</span>
                  </div>
                  <p className="listing-description">{listing.description.substring(0, 100)}...</p>
                  <div className="listing-meta">
                    <span className="listing-city">{listing.city}</span>
                    <span className="listing-category">{listing.category}</span>
                  </div>
                  {listing.tags && listing.tags.length > 0 && (
                    <div className="listing-tags">
                      {listing.tags.slice(0, 3).map((tag) => (
                        <span key={tag} className="tag">{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}
